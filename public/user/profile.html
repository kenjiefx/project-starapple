<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Profile</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="/widget/widget.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;700;900&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/kenjiefx/strawberry-js/dist/strawberry.v1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="/widget/app.js"></script>
  </head>
  <body>
    <section id="loader">
      <div class="loading">
        <img id="spinner" src="https://cdn.shopify.com/s/files/1/0560/7466/6159/files/spinner.gif?v=1646281504">
      </div>
    </section>
    <section xscope="profile" id="main">
      <header xcomponent="'/components/header.htm'"></header>
      <main class="with-header">
        <div class="standard-layout">
            <div class="left">
                <div xcomponent="'/components/profile-card.htm'"></div>
            </div>
            <div xpatch="userPosts" class="middle">
                <div class="posts-wrapper w-100">
                    <div class="post-section-header">
                        <div class="post-section-title">Posts</div>
                        <div xif="hasPosts==true">
                            <div class="post-section-about">Click on each post to leave a review</div>
                        </div>
                        <div xif="hasPosts==false">
                            <div class="post-section-about">You have no post at the moment. Create a new one!</div>
                        </div>
                    </div>
                    <div xif="isOwnView==true">
                        <div xpatch="newPostPreview" class="create-post-wrapper">
                            <div xclick="showModal('create-post')" class="create-post-preview" xstyle="hasCreatedPost()">
                                {{newPostContent}}
                            </div>
                        </div>
                        <div class="new-post-ctas flex">
                            <button xclick="submitNewPost()" type="button" class="button is-primary" xdisable="submitPostButton" name="button">Post</button>
                            <div xshow="imageUploader">
                              <div class="add-photo-button flex ac">
                                <div class="file">
                                  <label class="file-label">
                                    <input id="file-upload-handle" xchange="uploadPostPhoto()" class="file-input" type="file" name="resume" accept="image/png, image/jpeg" />
                                    <span class="flex">
                                      <span class="file-labels" style="margin-right:8px">
                                        Add Photo
                                      </span>
                                      <span class="file-icon-update">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" style="fill:#646464;transform: ;msFilter:;"><path d="M4 5h13v7h2V5c0-1.103-.897-2-2-2H4c-1.103 0-2 .897-2 2v12c0 1.103.897 2 2 2h8v-2H4V5z"></path><path d="m8 11-3 4h11l-4-6-3 4z"></path><path d="M19 14h-2v3h-3v2h3v3h2v-3h3v-2h-3z"></path></svg>
                                      </span>
                                    </span>
                                  </label>
                                </div>
                              </div>
                            </div>
                            <div xpatch="newPhotoPreviewer">
                              <div xif="newPostImage!==null">
                                <div class="post-photo-preview" style="background:url('{{newPostImage}}'); background-position: center; background-size: cover;"></div>
                              </div>
                            </div>
                        </div>
                    </div>
                    <div xrepeat="user.posts.list as post" class="w-100">
                        <div xclick="viewPost('{{post.postId}}')" class="single-post-container">
                            <div class="post-card">
                                <div class="post-card-header flex">
                                    <div class="post-card-left">
                                        <div class="post-card-profile-photo" style="background:url('{{$parent.user.profilePhoto}}');background-size: cover; background-position:center;"></div>
                                        <div class="flex ac post-card-user-ratings">
                                            <img src="/images/gray-star.svg" alt="">
                                            <div class="subtitle is-7">
                                                {{$parent.roundOff($parent.user.bottomLine.averageScore)}}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="post-card-middle">
                                        <div class="format-date">
                                            {{$parent.formatDate(post.createdAt)}} â€¢ {{post.visibility}}
                                        </div>
                                        <div class="flex ac">
                                            <div class="s-title">{{$parent.user.firstName}} {{$parent.user.lastName}}</div>
                                            <div class="post-card-username">@{{$parent.user.username}}</div>
                                        </div>
                                        <div class="post-card-body">
                                            {{post.postBody}}
                                        </div>
                                        <div xif="post.src!==null">
                                          <div class="post-listing-image-container">
                                            <div class="post-listing-image" style="background:url('{{post.src}}'); background-position: center; background-size: cover;"></div>
                                          </div>
                                        </div>
                                        <div class="post-card-bottomline flex ac">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;"><path d="M20 2H4c-1.103 0-2 .897-2 2v12c0 1.103.897 2 2 2h3v3.766L13.277 18H20c1.103 0 2-.897 2-2V4c0-1.103-.897-2-2-2zm0 14h-7.277L9 18.234V16H4V4h16v12z"></path><circle cx="15" cy="10" r="2"></circle><circle cx="9" cy="10" r="2"></circle></svg>
                                            <div class="">
                                                {{post.totalReviewsCount}} {{$parent.printPlural(post.totalReviewsCount,'Review','Reviews')}}
                                            </div>
                                            <div class="flex">
                                                {{$parent.calculateStars(post.totalReviewsCount,post.totalReviewsScore)}}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="post-card-right">
                                        <div xif="$parent.isOwnView==false">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill:#bfbfbf;transform: ;msFilter:;"><path d="m14.303 6-3-2H6V2H4v20h2v-8h4.697l3 2H20V6z"></path></svg>
                                        </div>
                                        <div xif="$parent.isOwnView==true">
                                          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" style="fill:#d9d9d9;transform: ;msFilter:;"><path d="M5 20a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8h2V6h-4V4a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v2H3v2h2zM9 4h6v2H9zM8 8h9v12H7V8z"></path><path d="M9 10h2v8H9zm4 0h2v8h-2z"></path></svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div xif="hasPosts==true">
                        <div class="has-post-notif w-100 flex jc subtitle is-7">
                            Some of the posts may be hidden depending on the visibility settings.
                        </div>
                    </div>
                </div>
            </div>
            <div class="right">
                <div class="profile-menu">
                    <div class="item s-title">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;"><path d="M7.5 14.5c-1.58 0-2.903 1.06-3.337 2.5H2v2h2.163c.434 1.44 1.757 2.5 3.337 2.5s2.903-1.06 3.337-2.5H22v-2H10.837c-.434-1.44-1.757-2.5-3.337-2.5zm0 5c-.827 0-1.5-.673-1.5-1.5s.673-1.5 1.5-1.5S9 17.173 9 18s-.673 1.5-1.5 1.5zm9-11c-1.58 0-2.903 1.06-3.337 2.5H2v2h11.163c.434 1.44 1.757 2.5 3.337 2.5s2.903-1.06 3.337-2.5H22v-2h-2.163c-.434-1.44-1.757-2.5-3.337-2.5zm0 5c-.827 0-1.5-.673-1.5-1.5s.673-1.5 1.5-1.5 1.5.673 1.5 1.5-.673 1.5-1.5 1.5z"></path><path d="M12.837 5C12.403 3.56 11.08 2.5 9.5 2.5S6.597 3.56 6.163 5H2v2h4.163C6.597 8.44 7.92 9.5 9.5 9.5s2.903-1.06 3.337-2.5h9.288V5h-9.288zM9.5 7.5C8.673 7.5 8 6.827 8 6s.673-1.5 1.5-1.5S11 5.173 11 6s-.673 1.5-1.5 1.5z"></path></svg>
                        Account Settings
                    </div>
                    <div xclick="logout()" class="item s-title">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;"><path d="m2 12 5 4v-3h9v-2H7V8z"></path><path d="M13.001 2.999a8.938 8.938 0 0 0-6.364 2.637L8.051 7.05c1.322-1.322 3.08-2.051 4.95-2.051s3.628.729 4.95 2.051 2.051 3.08 2.051 4.95-.729 3.628-2.051 4.95-3.08 2.051-4.95 2.051-3.628-.729-4.95-2.051l-1.414 1.414c1.699 1.7 3.959 2.637 6.364 2.637s4.665-.937 6.364-2.637c1.7-1.699 2.637-3.959 2.637-6.364s-.937-4.665-2.637-6.364a8.938 8.938 0 0 0-6.364-2.637z"></path></svg>
                        Logout
                    </div>
                </div>
            </div>
        </div>
      </main>
      <section xpatch="modalCtrl" id="modals">
          <button xclick="closeModal()" class="delete"></button>
          <div class="modal-content">
              <div xif="onCreatePost==true">
                  <div class="card createPost">
                      <div class="page title is-5">Write A Post</div>

                      <div class="post-card" style="margin-bottom: 25px;">
                          <div class="post-card-header flex">
                              <div class="post-card-left">
                                  <div class="post-card-profile-photo" style="background:url('{{user.profilePhoto}}');background-size: cover; background-position:center;"></div>
                              </div>
                              <div class="post-card-middle">
                                  <div class="format-date">
                                  </div>
                                  <div class="flex jc dir-col">
                                      <div class="s-title">{{user.firstName}} {{user.lastName}}</div>
                                      <div class="post-card-username-write">@{{user.username}}</div>
                                  </div>
                              </div>
                              <div class="post-card-right">
                                <div class="flex ac">
                                  <select xmodel="newPostVisibility" xchange="changeVisibility()" class="select visibility" name="">
                                    <option value="public">Public</option>
                                    <option value="private">Only Me</option>
                                  </select>
                                  <div xpatch="visibilityIcon" class="visibility-icon-cont">
                                    <div xif="newPostVisibility=='public'">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zM4 12c0-.899.156-1.762.431-2.569L6 11l2 2v2l2 2 1 1v1.931C7.061 19.436 4 16.072 4 12zm14.33 4.873C17.677 16.347 16.687 16 16 16v-1a2 2 0 0 0-2-2h-4v-3a2 2 0 0 0 2-2V7h1a2 2 0 0 0 2-2v-.411C17.928 5.778 20 8.65 20 12a7.947 7.947 0 0 1-1.67 4.873z"></path></svg>
                                    </div>
                                    <div xif="newPostVisibility=='private'">
                                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" style="fill: rgba(0, 0, 0, 1);transform: ;msFilter:;"><path d="M12 2C9.243 2 7 4.243 7 7v3H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-1V7c0-2.757-2.243-5-5-5zM9 7c0-1.654 1.346-3 3-3s3 1.346 3 3v3H9V7zm4 10.723V20h-2v-2.277a1.993 1.993 0 0 1 .567-3.677A2.001 2.001 0 0 1 14 16a1.99 1.99 0 0 1-1 1.723z"></path></svg>
                                    </div>
                                  </div>
                                </div>

                                </div>
                              </div>
                      </div>



                      <div class="field">
                          <textarea id="newPostBody" class="create-new-post" rows="4" cols="80"></textarea>
                      </div>
                      <div class="field flex create-post-cta">
                          <button xclick="saveNewPost()" type="button" class="button is-primary" name="button">Save</button>
                          <button xclick="closeModal()" type="button" class="button is-light" name="button">Cancel</button>
                      </div>
                  </div>
              </div>
          </div>
      </section>
    </section>
    <script type="text/javascript">

        app.scope('profile',function($scope,requester,url,grootSvc,$patch,$disable,$hide){
            $scope.requester = {
                name: requester.getName(),
                profilePhoto: requester.getPhoto(),
                username: requester.getUsername()
            }

            $scope.isOwnView = false;
            $scope.newPostContent = "What's on your mind?";
            $scope.newPostPending = false;
            $scope.newPostVisibility = 'public';
            $scope.newPostImage = null;
            $scope.hasCreatedPost=function(){
                if (!$scope.newPostPending) {
                    return 'with-placeholder';
                }
                return '';
            }
            $scope.changeVisibility=function(){
              $patch('visibilityIcon');
            }

            $scope.uploadPostPhoto=function(){
                var fd = new FormData();
                fd.append('myFile',$('#file-upload-handle')[0].files[0]);
                $.ajax({
                  url: 'http://127.0.0.1:8000/push',
                  method: 'POST',
                  data: fd,
                  processData: false,
                  contentType: false,
                  success:function(response){
                    $scope.newPostImage = response.path;
                    $patch('newPhotoPreviewer');
                    $hide('imageUploader');
                  }
                });

            }

            $scope.viewPost=function(postId){
                console.log('asdasdasd');
                location.href='/user/post.html?id='+postId;
            }

            $scope.onCreatePost = false;

            $scope.showModal=function(modalType){
                if (modalType==='create-post') {
                    $scope.onCreatePost = true;
                    $patch('modalCtrl');
                    if ($scope.newPostPending==true) {
                        $('#newPostBody').val($scope.newPostContent);
                    }
                    $('#modals').fadeIn();
                }
            }
            $scope.closeModal=function(){
                $('#modals').fadeOut();
            }
            $scope.saveNewPost=function(){
                $disable('submitPostButton',true);
                let pendingContent = $('#newPostBody').val().trim();
                if (pendingContent==='') {
                    $scope.newPostContent = "What's on your mind?";
                    $scope.newPostPending = false;
                    $patch('newPostPreview');
                    $('#modals').fadeOut();
                    return;
                }
                $scope.newPostContent = pendingContent;
                $scope.newPostPending = true;
                $patch('newPostPreview');
                $disable('submitPostButton',false);
                $('#modals').fadeOut();
            }

            $scope.submitNewPost=function(button){
                button.addClass('is-loading');
                let pendingContent = $scope.newPostContent.replace(/(\r\n|\n|\r)/gm, "")
                $.ajax({
                    method:'POST',
                    url:grootSvc.root+'v1/posts/create',
                    data:JSON.stringify({
                        token: requester.getToken(),
                        postTitle: '',
                        postBody: pendingContent,
                        visibility: $scope.newPostVisibility,
                        photo: $scope.newPostImage
                    }),
                    success:function(response){
                        location.reload();
                    },
                    error:function(response){
                        console.log(response);
                    }
                });
            }

            let username = url.get('user');
            if (username===null) {
                username = $scope.requester.username;
            }
            if (username===$scope.requester.username) {
                $scope.isOwnView = true;
            }

            $.ajax({
                method:'GET',
                url:grootSvc.root+'v1/reviews/get/user?profile='+username+'&publickey='+grootSvc.publicKey+'&token='+requester.getToken(),
                success:function(response){
                    console.log(response);
                    $scope.user = response;
                    if (response.profilePhoto===null) {
                        $scope.user.profilePhoto = '/images/empty-profile.png';
                    }
                    if (response.posts.list.length>0) {
                        $scope.hasPosts = true;
                    } else {
                        $scope.hasPosts = false;
                    }
                    $patch('userCard');
                    $patch('userPosts');
                },
                error:function(response){
                    console.log(response);
                }
            });




            if (requester.isOnline()==='offline') {
                location.href='/login.html';
            }
            $scope.logout=function(){
                requester.setOffline();
                location.href='/login.html';
            }
            $scope.generateStars=function(average){
                if (average!==undefined) {
                    let floor = Math.floor(average);

                    let template = '';
                    let fullStar = '<img src="/images/full-star.svg">';
                    let halfStar = '<img src="/images/half-star.svg">';
                    let emptyStar = '<img src="/images/empty-star.svg">';
                    for (var i = 1; i < 6; i++) {
                        if (i<floor+1) {
                            template = template+fullStar;
                        } else {
                            let dec = 5-average;
                            if (dec!==0&&dec<1) {
                                template = template+halfStar;
                            } else {
                                template = template+emptyStar;
                            }
                        }
                    }

                    return template;
                }
                return '';
            }
            $scope.calculateStars=function(totalReviewsCount,totalReviewsScore){
                let average = totalReviewsScore / totalReviewsCount;
                let averageInDecimal = '0.0';
                if (average>0) {
                    averageInDecimal = average.toFixed(1);
                }
                return '<div class="post-card-star-icons">'+$scope.generateStars(average)+'</div><div class="post-card-ave-score">'+averageInDecimal+'</div>';
            }
            $scope.printPlural=function(count,singular,plural){
                if (count==1) {
                    return singular;
                }
                return plural;
            }
            $scope.formatDate=function(date){
                return moment(date).format('MMMM D, YYYY');
            }
            $scope.roundOff=function(average){
                if (average==undefined) {
                    return '0.0';
                }
                if (average===0) {
                    return '0.0';
                }
                return average.toFixed(2);
            }
        });
    </script>
  </body>
</html>
